
--DATA PREPARATION AND UNDERSTANDING
----1. What is the total number of rows in each of the 3 tables in the database?
---Ans.:   
        select count(*)no_row from transactions
		select count(*)no_row from prod_cat_info
		select count(*)no_row from customer

----2. What is the total number of transactions that have a return?
---Ans.:
		select count(*)transactions_return from transactions
		where Qty<0

----3. As you would have noticed, the dates provided across the datasets are not in a correct
--format. As first steps, pls convert the date variables into valid date formats before proceeding ahead.
---Ans.: 
		select convert(date,tran_date,105) from transactions
		--- i am doing it peramanent change by using this query:- 
		update transactions 
		set tran_date=convert(date,tran_date,105)
		

----4. What is the time range of the transaction data available for analysis? Show the
----output in number of days, months and years simultaneously in different columns.
---Ans.: 
		select transaction_id,day(tran_date)days,month(tran_date)months,year(tran_date)year
		from transactions
		order by 4 asc, 3 asc,2 asc

----5. Which product category does the sub-category "DIY" belong to?
--Ans.: 
		select * from prod_cat_info
		where prod_subcat='DIY'





--(DATA ANALYSIS

---1. Which channel is most frequently used for transactions?
--Ans.: 

		select  store_type,count(*)fr_ch from transactions
		group by store_type
		order by count(*) desc

		
---2. What is the count of Male and Female customers in the database?
--Ana.: 
	select gender,count(*) from customer
	group by gender
	order by count(*) desc
----3. From which city do we have the maximum number of customers and how many?
---Ans.: 
		select top 1 city_code,count(*)  from customer
		group by city_code
		order by 2 desc
---4. How many sub-categories are there under the Books category?
---Ans.: 
		select  prod_cat,count(distinct prod_subcat)sub_cat from prod_cat_info
		group by prod_cat
		having prod_cat='books'
	
---5. What is the maximum quantity of products ever ordered?
---Ans.: 
		select prod_subcat_code,sum(qty) from transactions
		group by prod_subcat_code
		order by 2 desc

--6. What is the net total revenue generated in categories Electronics and Books?
--Ans.: 
		select prod_cat_code,prod_cat from prod_cat_info
		group by prod_cat,prod_cat_code
		having prod_cat in ( 'electronics', 'books')

		select prod_cat_code,sum(total_amt)revenue from transactions
		group by prod_cat_code
		having prod_cat_code in (select prod_cat_code from prod_cat_info
		group by prod_cat,prod_cat_code
		having prod_cat in ( 'electronics', 'books'))

--7. How many customers have >10 transactions with us, excluding returns?
--Ans.:
		select cust_id,count(transaction_id) from transactions
		where rate>0
		group by cust_id
		having count(transaction_id)<10

--8. What is the combined revenue earned from the "Electronics" & "Clothing" categories, from "Flagship stores"?
--Ans.: 
		
		select prod_cat_code,prod_cat from prod_cat_info
		group by prod_cat_code,prod_cat
		having prod_cat in ('electronics','clothing')

		select prod_cat_code,sum(cast(total_amt as float))revenue from transactions
		where rate >0 and store_type in ('Flagship store')
		group by prod_cat_code
		having prod_cat_code in (select prod_cat_code from prod_cat_info
		group by prod_cat_code,prod_cat
		having prod_cat in ('electronics','clothing'))

--9. What is the total revenue generated from "Male" customers in "Electronics" category? Output should display 
--total revenue by prod sub-cat.
--Ans.:
		select prod_cat,prod_sub_cat_code,prod_subcat from prod_cat_info m
		where prod_cat='electronics'

		SELECT prod_subcat_code,sum(cast(total_amt as float ))total_revenue FROM TRANSACTIONS
		where prod_cat_code in (select prod_cat_code from prod_cat_info
			group by prod_cat_code,prod_cat 
			having prod_cat='electronics') and 
			cust_id in(select customer_id from customer
			where gender='m')
		group by prod_subcat_code
		order by prod_subcat_code 

		
---10. What is percentage of sales and returns by product sub category; display only top 5 sub categories
----in terms of sales?
--Ans.:            **SALES PERECENTAGE**
		select top 5 prod_cat_code,prod_subcat_code,sum(total_amt)revenue,(sum(total_amt)/
		(select sum(cast(total_amt as float)) from transactions where qty>0))percentage from transactions
		where qty >0
		group by prod_cat_code,prod_subcat_code
		order by 1 

--		         **RETURN PERCENTAGE**
		select top 5 prod_cat_code,prod_subcat_code,sum(total_amt)revenue,(sum(total_amt)/
		(select sum(cast(total_amt as float)) from transactions where qty<0))percentage from transactions
		where qty <0
		group by prod_cat_code,prod_subcat_code
		order by 1 

--11. For all customers aged between 25 to 35 years find what is the net total revenue
--generated by these consumers in last 30 days of transactions from max transaction date available in the data?
--Ans.: 
--						** This is the list of last 30 days of the customers whose age between 25 and 35 **
		select cust_id,count(*)ntime,max(tran_date)last_tran,(
		select dob from customer
		where customer.customer_id=transactions.cust_id)dob,datediff(year,((
		select convert(date,dob,105) from customer
		where customer.customer_id=transactions.cust_id)),(max(tran_date)))age,sum(total_amt)revenue from transactions
		group by cust_id
		having max(tran_date)>=(select convert(date,dateadd(day,-30,max(tran_date)),105) from transactions) and datediff(year,((
		select convert(date,dob,105) from customer
		where customer.customer_id=transactions.cust_id)),(max(tran_date))) between 25 and 35 
		order by 6 desc
--					**	THIS IS THE TOTAL REVENUE GENERATED BY LAST 30 DAYS OF CUSTOMES HAVING AGE 25 AND 35**
	
with ty as (
select cust_id,count(*)ntime,max(tran_date)last_tran,(
		select dob from customer
		where customer.customer_id=transactions.cust_id)dob,datediff(year,((
		select convert(date,dob,105) from customer
		where customer.customer_id=transactions.cust_id)),(max(tran_date)))age,sum(total_amt)revenue from transactions
		group by cust_id
		having max(tran_date)>=(select convert(date,dateadd(day,-30,max(tran_date)),105) from transactions) and datediff(year,((
		select convert(date,dob,105) from customer
		where customer.customer_id=transactions.cust_id)),(max(tran_date))) between 25 and 35 
		)
		select sum(revenue)total_revenue from ty
	
--12. which product category has seen the max value of return in the last 3 months of transaction?
--Ans. 

		select prod_cat_code,count(*) from transactions
		where tran_date>=(select convert(date,dateadd(month,-3,max(tran_date)),105)from transactions) and qty<0
		group by prod_cat_code
		order by 2 desc
			
--13. which store type sells the maximum products by value of sales amount and by quantity sold?
--Ans.: 
		select store_type,count(prod_cat_code)products,sum(qty)total_qty,sum(total_amt)total_amt from transactions
		where qty>0
		group by store_type
		order by 4 desc

--14. what are the categories for which average revenue is above the overall average.
--Ans.: 
		select prod_cat_code,avg(total_amt)avg_revenue from transactions
		where qty>0
		group by prod_cat_code
		having avg(total_amt)>=(select avg(total_amt) from transactions
		where qty>0)
		order by 1 asc
		
--15. find the average and total revenue by each subcategory for the categories which are
--among top 5 categories in terms of quantity sold.
--Ans.: 
		select top 5 prod_cat_code,prod_subcat_code,sum(qty)total_qty,avg(total_amt)average,sum(total_amt)total from transactions
		where qty>0
		group by prod_cat_code,prod_subcat_code
		order by 3 desc






		



